# 🏗️ 项目架构与依赖分析

## 📊 模块依赖层级图

```
┌─────────────────────────────────────────────────────────────┐
│                      应用层 (Entry Points)                    │
├─────────────────────────────────────────────────────────────┤
│  main.py                     main_voice.py                   │
│  (文本交互)                   (语音交互)                       │
└─────────────┬────────────────────────────┬──────────────────┘
              │                            │
              ▼                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      会话层 (Session Layer)                   │
├─────────────────────────────────────────────────────────────┤
│  conversation_session.py     voice_interaction_session.py    │
│  (LLM+TTS会话管理)            (完整语音交互会话)               │
└─────────────┬────────────────────────────┬──────────────────┘
              │                            │
              ▼                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      核心层 (Core Layer)                      │
├─────────────────────────────────────────────────────────────┤
│  agent_hybrid.py                                             │
│  (混合架构Agent: OpenAI API + LangChain Tools)                │
└─────────────┬──────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────┐
│                     工具层 (Tools Layer)                      │
├─────────────────────────────────────────────────────────────┤
│  tools.py             tts_optimizer.py                       │
│  (17个工具定义)        (TTS文本优化)                          │
│                                                              │
│  voice_feedback.py                                          │
│  (语音反馈/音效)                                             │
└─────────────┬──────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────┐
│                     语音层 (Speech Layer)                     │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ ASR 模块      │  │ TTS 模块      │  │ VAD 模块      │     │
│  ├──────────────┤  ├──────────────┤  ├──────────────┤     │
│  │asr_interface │  │tts_interface │  │vad_processor │     │
│  └──────────────┘  │streaming_tts │  │audio_recorder│     │
│                    │  _pipeline   │  └──────────────┘     │
│                    └──────────────┘                        │
└─────────────┬──────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────┐
│                     基础层 (Foundation Layer)                 │
├─────────────────────────────────────────────────────────────┤
│  config.py                    logger_config.py              │
│  (配置管理)                    (日志管理)                     │
└─────────────────────────────────────────────────────────────┘
```

## 🔗 核心模块依赖关系

### 1. 应用入口

#### `main.py` (文本交互)

```
main.py
├── conversation_session
│   ├── agent_hybrid
│   │   ├── config
│   │   ├── logger_config
│   │   ├── streaming_tts_pipeline
│   │   ├── tts_interface
│   │   ├── tts_optimizer
│   │   └── voice_feedback
│   ├── config
│   ├── logger_config
│   └── tts_interface
├── voice_feedback
└── logger_config
```

#### `main_voice.py` (语音交互)

```
main_voice.py
├── conversation_session (同上)
├── asr_interface
│   ├── config
│   └── logger_config
├── voice_feedback
│   └── logger_config
└── config
```

### 2. 核心业务模块

#### `agent_hybrid.py` (最复杂的模块)

**依赖：**

- `config` - 配置参数
- `logger_config` - 日志系统
- `streaming_tts_pipeline` - 流式 TTS 管道
- `tts_interface` - TTS 接口
- `tts_optimizer` - TTS 文本优化
- `voice_feedback` - 语音反馈/音效

**被依赖：**

- `conversation_session.py`
- `main.py`

#### `conversation_session.py` (会话管理器)

**依赖：**

- `agent_hybrid` - LLM Agent
- `tts_interface` - TTS 引擎
- `config` - 配置
- `logger_config` - 日志

**被依赖：**

- `main.py`
- `main_voice.py`
- `voice_interaction_session.py`

#### `voice_interaction_session.py` (完整语音交互)

**依赖：**

- `conversation_session` - 会话管理
- `asr_interface` - 语音识别
- `audio_recorder` - 音频录制
- `vad_processor` - VAD 处理
- `config` - 配置
- `logger_config` - 日志

**被依赖：** 无（已废弃，由 `main_voice.py` 替代）

### 3. 语音处理模块

#### ASR 模块

- `asr_interface.py` → `config`, `logger_config`

#### TTS 模块

- `tts_interface.py` → 无依赖（基础模块）
- `streaming_tts_pipeline.py` → 无本地依赖
- `tts_optimizer.py` → `tts_interface`

#### VAD/录音模块

- `vad_processor.py` → `logger_config`
- `audio_recorder.py` → `vad_processor`, `logger_config`

### 4. 工具模块

- `tools.py` → `tts_interface`
- `voice_feedback.py` → `logger_config`

### 5. 基础模块

- `config.py` → 无本地依赖
- `logger_config.py` → 无本地依赖

## 📦 模块分类

### 核心业务模块 (Core)

- `agent_hybrid.py` - LLM Agent (OpenAI + LangChain)
- `conversation_session.py` - 会话管理器
- `tools.py` - 17 个工具定义

### 语音处理模块 (Speech)

- `asr_interface.py` - ASR 接口 (OpenAI Whisper)
- `tts_interface.py` - TTS 接口 (Edge/Azure/OpenAI)
- `streaming_tts_pipeline.py` - 流式 TTS 管道
- `tts_optimizer.py` - TTS 文本优化
- `vad_processor.py` - VAD 处理 (webrtcvad)
- `audio_recorder.py` - 音频录制 (pyaudio)
- `voice_feedback.py` - 语音反馈/音效 (pygame)

### 工具模块 (Utils)

- `config.py` - 配置管理
- `logger_config.py` - 日志管理

### 应用入口 (Apps)

- `main.py` - 文本交互入口
- `main_voice.py` - 语音交互入口

### 废弃模块 (Deprecated)

- `voice_interaction_session.py` - 已被 `main_voice.py` 替代

## 🚨 当前问题

### 1. 测试文件散落

- ❌ 根目录下有 4 个测试文件应该移到 `test/`
  - `test_asr_interactive.py`
  - `test_asr_simple.py`
  - `test_microphone.py`
  - `test_vad_asr.py`

### 2. 临时文件过多

- ❌ `temp_audio/` 有 69 个 WAV 文件
- ❌ `sessions/` 有 23 个会话记录

### 3. 循环依赖风险

- ⚠️ `conversation_session` ↔ `agent_hybrid` ↔ `tts_interface` 存在潜在循环

### 4. 模块职责不清

- ⚠️ `voice_interaction_session.py` 已被废弃但仍存在

## 💡 优化建议

### 短期（立即执行）

1. ✅ 移动测试文件到 `test/`
2. ✅ 清理临时文件（`temp_audio/`, `sessions/`）
3. ✅ 删除废弃文件 `voice_interaction_session.py`

### 中期（下周）

1. 创建 `src/` 目录，模块化重构
2. 解除循环依赖
3. 统一配置管理（使用 YAML）

### 长期（下个月）

1. 实现 Prompt RAG（向量化规则库）
2. 微服务化（ASR/TTS/LLM 分离）
3. 添加 API 接口层

## 📈 复杂度分析

| 模块                        | 依赖数 | 被依赖数 | 复杂度     | 优先级 |
| --------------------------- | ------ | -------- | ---------- | ------ |
| `config.py`                 | 0      | 7        | ⭐         | 🔴 高  |
| `logger_config.py`          | 0      | 9        | ⭐         | 🔴 高  |
| `tts_interface.py`          | 0      | 5        | ⭐⭐       | 🔴 高  |
| `agent_hybrid.py`           | 6      | 2        | ⭐⭐⭐⭐⭐ | 🔴 高  |
| `conversation_session.py`   | 4      | 3        | ⭐⭐⭐⭐   | 🔴 高  |
| `streaming_tts_pipeline.py` | 0      | 1        | ⭐⭐⭐     | 🟡 中  |
| `asr_interface.py`          | 2      | 3        | ⭐⭐       | 🟡 中  |
| `vad_processor.py`          | 1      | 1        | ⭐         | 🟢 低  |
| `voice_feedback.py`         | 1      | 2        | ⭐         | 🟢 低  |

**说明：**

- **依赖数**：该模块依赖多少其他模块
- **被依赖数**：有多少模块依赖该模块
- **复杂度**：综合评估（⭐ = 低，⭐⭐⭐⭐⭐ = 高）
- **优先级**：修改时的风险等级

