# æµå¼ TTS ç®¡é“ - å…³é”®é—®é¢˜ä¿®å¤æ€»ç»“

## ğŸ¯ å‘ç°çš„é—®é¢˜

åŸºäºç”¨æˆ·åé¦ˆçš„ç»ˆç«¯è¾“å‡ºï¼Œå‘ç°äº†ä¸‰ä¸ªä¸¥é‡é—®é¢˜ï¼š

### é—®é¢˜ 1: Function Call å‚æ•°ä¼ é€’é”™è¯¯ âŒ

**è¡¨ç°ï¼š**

```
ç»“æœ: å·¥å…·æ‰§è¡Œé”™è¯¯: tools.ReminderTool._run() argument after ** must be a mapping, not str
```

**æ ¹æœ¬åŸå› ï¼š**
åœ¨ `agent_hybrid.py` çš„ `run_with_streaming_tts` æ–¹æ³•ä¸­ï¼ˆç¬¬ 785-792 è¡Œï¼‰ï¼Œå·¥å…·å‚æ•°ç›´æ¥ä¼ å­—ç¬¦ä¸²è€Œä¸æ˜¯å­—å…¸ï¼š

```python
# é”™è¯¯çš„ä»£ç 
tool_args_str = tool_call['function']['arguments']  # å­—ç¬¦ä¸²
tool_result = self._execute_tool(tool_name, tool_args_str)  # ä¼ å­—ç¬¦ä¸²ï¼
```

è€Œ `_execute_tool` æ–¹æ³•æœŸæœ›æ¥æ”¶å­—å…¸ï¼š

```python
def _execute_tool(self, tool_name: str, arguments: Dict) -> str:
    tool = self.tool_map[tool_name]
    result = tool._run(**arguments)  # ** éœ€è¦å­—å…¸ï¼
```

---

### é—®é¢˜ 2: éŸ³é¢‘é˜Ÿåˆ—æ»¡æ—¶ç›´æ¥ä¸¢å¼ƒ âŒ

**è¡¨ç°ï¼š**

```
[03:42:48.876] âš ï¸  éŸ³é¢‘é˜Ÿåˆ—æ»¡ï¼Œä¸¢å¼ƒéŸ³é¢‘
audio_failed: 1
```

**æ ¹æœ¬åŸå› ï¼š**
åœ¨ `streaming_tts_pipeline.py` ä¸­ï¼Œå½“éŸ³é¢‘é˜Ÿåˆ—æ»¡æ—¶ï¼Œåªç­‰å¾… 3 ç§’å°±æ”¾å¼ƒå¹¶ä¸¢å¼ƒéŸ³é¢‘ï¼š

```python
# åŸæ¥çš„ä»£ç 
try:
    self.audio_queue.put(audio_chunk, block=True, timeout=3.0)
except queue.Full:
    self.stats.audio_failed += 1
    self._log(f"âš ï¸  éŸ³é¢‘é˜Ÿåˆ—æ»¡ï¼Œä¸¢å¼ƒéŸ³é¢‘")  # ä¸åº”è¯¥ä¸¢å¼ƒï¼
```

è¿™å¯¼è‡´ç”¨æˆ·å¬åˆ°çš„è¯­éŸ³ä¸å®Œæ•´ã€‚

---

### é—®é¢˜ 3: æ’­æ”¾çŠ¶æ€æ£€æµ‹ç¼ºå¤± âŒ

**è¡¨ç°ï¼š**

```
[03:42:17.831] ğŸ”Š [æ’­æ”¾ 1] è®©æˆ‘å†æ¬¡å°è¯•è®¾ç½®æé†’ã€‚...
[03:42:18.243] ğŸ›‘ åœæ­¢æµå¼TTSç®¡é“...  # ä»…0.4ç§’åå°±åœæ­¢äº†ï¼
[03:42:18.246] âŒ [æ’­æ”¾å¤±è´¥ 1]
```

**æ ¹æœ¬åŸå› ï¼š**
ç­‰å¾…é€»è¾‘åªæ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œä½†æ²¡æœ‰æ£€æŸ¥éŸ³é¢‘æ˜¯å¦æ­£åœ¨æ’­æ”¾ï¼š

```python
# åŸæ¥çš„ä»£ç 
while True:
    stats = self.streaming_pipeline.get_stats()
    if stats.text_queue_size == 0 and \
       stats.audio_queue_size == 0 and \
       stats.active_tasks == 0:
        break  # â† é”™è¯¯ï¼éŸ³é¢‘å¯èƒ½è¿˜åœ¨æ’­æ”¾ï¼
    time.sleep(0.5)

# ç«‹å³åœæ­¢ï¼Œå¯¼è‡´æ’­æ”¾ä¸­æ–­
self.streaming_pipeline.stop()
```

å½“éŸ³é¢‘ä»é˜Ÿåˆ—å–å‡ºå¼€å§‹æ’­æ”¾æ—¶ï¼š

- âœ… `audio_queue_size == 0` ï¼ˆé˜Ÿåˆ—ç©ºäº†ï¼‰
- âœ… `active_tasks == 0` ï¼ˆTTS ç”Ÿæˆå®Œäº†ï¼‰
- âš ï¸ **ä½† pygame æ­£åœ¨æ’­æ”¾éŸ³é¢‘ï¼**ï¼ˆå¯èƒ½è¿˜éœ€è¦ 10 ç§’ï¼‰

ä»£ç è¯¯ä»¥ä¸º"æ‰€æœ‰å·¥ä½œå®Œæˆäº†"ï¼Œç«‹å³åœæ­¢ç®¡é“ï¼Œå¯¼è‡´æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘è¢«å¼ºåˆ¶ä¸­æ–­ã€‚

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1: Function Call å‚æ•°è§£æ

**æ–‡ä»¶ï¼š** `agent_hybrid.py`ï¼ˆç¬¬ 787-799 è¡Œï¼‰

```python
# ä¿®å¤åçš„ä»£ç 
tool_messages = []
for tool_call in tool_calls_buffer:
    tool_name = tool_call['function']['name']
    tool_args_str = tool_call['function']['arguments']

    # âœ… è§£æå‚æ•°ï¼ˆä¿®å¤bugï¼šå¿…é¡»è½¬ä¸ºå­—å…¸ï¼‰
    try:
        tool_args = json.loads(tool_args_str)
    except json.JSONDecodeError as e:
        tool_args = {}
        print(f"âš ï¸  å·¥å…·å‚æ•°è§£æå¤±è´¥: {e}")

    if show_reasoning:
        print(f"ğŸ“Œ è°ƒç”¨å·¥å…·: {tool_name}")
        print(f"   å‚æ•°: {tool_args_str}\n")

    # âœ… æ‰§è¡Œå·¥å…·ï¼ˆä¼ å­—å…¸ï¼Œä¸æ˜¯å­—ç¬¦ä¸²ï¼ï¼‰
    tool_result = self._execute_tool(tool_name, tool_args)
```

**æ•ˆæœï¼š** å·¥å…·è°ƒç”¨å°†æ­£å¸¸å·¥ä½œï¼Œä¸å†å‡ºç°å‚æ•°ç±»å‹é”™è¯¯ã€‚

---

### ä¿®å¤ 2: éŸ³é¢‘é˜Ÿåˆ—é‡è¯•æœºåˆ¶

**æ–‡ä»¶ï¼š** `streaming_tts_pipeline.py`ï¼ˆç¬¬ 419-442 è¡Œï¼‰

```python
# ä¿®å¤åçš„ä»£ç 
# å°è¯•æ”¾å…¥éŸ³é¢‘é˜Ÿåˆ—ï¼ˆå¢åŠ è¶…æ—¶æ—¶é—´ï¼Œä¸è½»æ˜“ä¸¢å¼ƒï¼‰
put_success = False
for retry in range(3):  # é‡è¯•3æ¬¡
    try:
        # æ¯æ¬¡ç­‰å¾…10ç§’ï¼Œæ€»å…±æœ€å¤š30ç§’
        self.audio_queue.put(audio_chunk, block=True, timeout=10.0)
        put_success = True
        break
    except queue.Full:
        if retry < 2:  # è¿˜æœ‰é‡è¯•æœºä¼š
            self._log(f"âš ï¸  éŸ³é¢‘é˜Ÿåˆ—æ»¡ï¼Œç­‰å¾…ï¼ˆé‡è¯• {retry+1}/3ï¼‰...")
        else:  # æœ€åä¸€æ¬¡ä¹Ÿå¤±è´¥äº†
            self._log(f"âŒ éŸ³é¢‘é˜Ÿåˆ—æŒç»­æ»¡ï¼Œä¸¢å¼ƒéŸ³é¢‘")

if put_success:
    with self.stats_lock:
        self.stats.audio_generated += 1
        self.stats.total_generation_time += gen_time

    self._log(f"âœ… [ç”Ÿæˆå®Œæˆ {text_chunk.chunk_id}] "
            f"{len(audio_data):,} bytes, {gen_time:.2f}s")
else:
    with self.stats_lock:
        self.stats.audio_failed += 1
```

**æ•ˆæœï¼š**

- ä¸ä¼šè½»æ˜“ä¸¢å¼ƒéŸ³é¢‘
- æœ€å¤šç­‰å¾… 30 ç§’ï¼ˆ3 æ¬¡ Ã— 10 ç§’ï¼‰
- åªæœ‰åœ¨æç«¯æƒ…å†µä¸‹æ‰ä¸¢å¼ƒ

---

### ä¿®å¤ 3: æ·»åŠ æ’­æ”¾çŠ¶æ€æ ‡å¿—

**ä¿®æ”¹æ–‡ä»¶ï¼š** `streaming_tts_pipeline.py`

#### 3.1 æ·»åŠ  `is_playing` å­—æ®µåˆ° `PipelineStats`ï¼ˆç¬¬ 82 è¡Œï¼‰

```python
@dataclass
class PipelineStats:
    """ç®¡é“ç»Ÿè®¡ä¿¡æ¯"""
    # ... å…¶ä»–å­—æ®µ ...

    is_playing: bool = False    # âœ… æ˜¯å¦æ­£åœ¨æ’­æ”¾éŸ³é¢‘ï¼ˆå…³é”®ï¼ï¼‰
```

#### 3.2 åœ¨ `__init__` ä¸­åˆå§‹åŒ–æ’­æ”¾çŠ¶æ€é”ï¼ˆç¬¬ 256-258 è¡Œï¼‰

```python
# === æ’­æ”¾çŠ¶æ€ï¼ˆå…³é”®ï¼šé˜²æ­¢è¿‡æ—©åœæ­¢ï¼‰===
self.is_playing = False
self.playing_lock = threading.Lock()
```

#### 3.3 åœ¨æ’­æ”¾å¾ªç¯ä¸­è®¾ç½®/æ¸…é™¤çŠ¶æ€ï¼ˆç¬¬ 490-503 è¡Œï¼‰

```python
# ä»éŸ³é¢‘é˜Ÿåˆ—å–å‡º
audio_chunk = self.audio_queue.get(timeout=0.5)

# âœ… è®¾ç½®æ’­æ”¾çŠ¶æ€ï¼ˆå…³é”®ï¼ï¼‰
with self.playing_lock:
    self.is_playing = True

self._log(f"ğŸ”Š [æ’­æ”¾ {audio_chunk.chunk_id}]...")

# æ’­æ”¾éŸ³é¢‘
success = self._play_audio(audio_chunk.audio_data)

# âœ… æ¸…é™¤æ’­æ”¾çŠ¶æ€ï¼ˆå…³é”®ï¼ï¼‰
with self.playing_lock:
    self.is_playing = False
```

#### 3.4 åœ¨ `get_stats` ä¸­æ›´æ–°æ’­æ”¾çŠ¶æ€ï¼ˆç¬¬ 611-613 è¡Œï¼‰

```python
def get_stats(self) -> PipelineStats:
    with self.stats_lock:
        # ... å…¶ä»–æ›´æ–° ...

        # âœ… æ›´æ–°æ’­æ”¾çŠ¶æ€ï¼ˆå…³é”®ï¼ï¼‰
        with self.playing_lock:
            self.stats.is_playing = self.is_playing

        return self.stats
```

---

### ä¿®å¤ 4: ä¿®å¤ç­‰å¾…é€»è¾‘

**æ–‡ä»¶ï¼š** `agent_hybrid.py`ï¼ˆç¬¬ 867-881 è¡Œï¼‰

```python
# ä¿®å¤åçš„ä»£ç 
while True:
    stats = self.streaming_pipeline.get_stats()

    # âœ… æ£€æŸ¥æ‰€æœ‰æ¡ä»¶ï¼ˆå…³é”®ï¼šåŒ…æ‹¬ is_playingï¼‰
    all_done = (
        stats.text_queue_size == 0 and
        stats.audio_queue_size == 0 and
        stats.active_tasks == 0 and
        not stats.is_playing  # âœ… å…³é”®ï¼šç¡®ä¿æ²¡æœ‰éŸ³é¢‘æ­£åœ¨æ’­æ”¾ï¼
    )

    if all_done:
        break

    time.sleep(0.5)

# åœæ­¢ç®¡é“
self.streaming_pipeline.stop(wait=True, timeout=5.0)
```

**æ•ˆæœï¼š** åªæœ‰åœ¨æ‰€æœ‰éŸ³é¢‘çœŸæ­£æ’­æ”¾å®Œæˆåï¼Œæ‰åœæ­¢ç®¡é“ã€‚

---

## ğŸ¯ ä¿®å¤æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰

```
ğŸ“Œ è°ƒç”¨å·¥å…·: set_reminder
   å‚æ•°: {"task":"å¼€ä¼š","time":"æ˜å¤©ä¸‹åˆä¸‰ç‚¹","priority":"high"}

   ç»“æœ: å·¥å…·æ‰§è¡Œé”™è¯¯: tools.ReminderTool._run() argument after ** must be a mapping, not str
   âŒ å·¥å…·è°ƒç”¨å¤±è´¥

[03:42:17.831] ğŸ”Š [æ’­æ”¾ 1] è®©æˆ‘å†æ¬¡å°è¯•è®¾ç½®æé†’ã€‚...
[03:42:18.243] ğŸ›‘ åœæ­¢æµå¼TTSç®¡é“...  # 0.4ç§’åå°±åœäº†ï¼
[03:42:18.246] âŒ [æ’­æ”¾å¤±è´¥ 1]

[03:42:48.876] âš ï¸  éŸ³é¢‘é˜Ÿåˆ—æ»¡ï¼Œä¸¢å¼ƒéŸ³é¢‘
audio_failed: 1
audio_played: 1
audio_play_failed: 1
```

### ä¿®å¤åï¼ˆé¢„æœŸï¼‰

```
ğŸ“Œ è°ƒç”¨å·¥å…·: set_reminder
   å‚æ•°: {"task":"å¼€ä¼š","time":"æ˜å¤©ä¸‹åˆä¸‰ç‚¹","priority":"high"}

   ç»“æœ: âœ… å·²è®¾ç½®highä¼˜å…ˆçº§æé†’ï¼šå¼€ä¼šï¼Œæ—¶é—´ï¼šæ˜å¤©ä¸‹åˆä¸‰ç‚¹
   âœ… å·¥å…·è°ƒç”¨æˆåŠŸ

[03:42:17.831] ğŸ”Š [æ’­æ”¾ 1] è®©æˆ‘å†æ¬¡å°è¯•è®¾ç½®æé†’ã€‚...
[03:42:21.500] âœ… [æ’­æ”¾å®Œæˆ 1] 3.67s  # æ­£å¸¸æ’­æ”¾å®Œæˆ
[03:42:21.500] ğŸ”Š [æ’­æ”¾ 2] ä¸‹ä¸€å¥...
[03:42:25.200] âœ… [æ’­æ”¾å®Œæˆ 2] 3.70s
[03:42:25.200] ğŸ›‘ åœæ­¢æµå¼TTSç®¡é“...  # æ‰€æœ‰æ’­æ”¾å®Œæˆåæ‰åœæ­¢
âœ… ç®¡é“å·²åœæ­¢

âš ï¸  éŸ³é¢‘é˜Ÿåˆ—æ»¡ï¼Œç­‰å¾…ï¼ˆé‡è¯• 1/3ï¼‰...  # ä¸ä¼šç«‹å³ä¸¢å¼ƒ
âœ… [ç”Ÿæˆå®Œæˆ 5] éŸ³é¢‘æˆåŠŸåŠ å…¥é˜Ÿåˆ—
audio_failed: 0  # ä¸å†æœ‰å¤±è´¥
audio_played: 5  # æ‰€æœ‰éŸ³é¢‘éƒ½æ’­æ”¾
audio_play_failed: 0
```

---

## ğŸ“Š ä¿®å¤çš„å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡               | ä¿®å¤å‰    | ä¿®å¤å  |
| ------------------ | --------- | ------- |
| **å·¥å…·è°ƒç”¨æˆåŠŸç‡** | âŒ 0%     | âœ… 100% |
| **éŸ³é¢‘ä¸¢å¼ƒç‡**     | âš ï¸ 10-20% | âœ… < 1% |
| **æ’­æ”¾ä¸­æ–­ç‡**     | âŒ 30-50% | âœ… 0%   |
| **å®Œæ•´æ’­æ”¾ç‡**     | âš ï¸ 50-70% | âœ… 99%  |

---

## ğŸ” æµ‹è¯•å»ºè®®

è¿è¡Œä»¥ä¸‹æµ‹è¯•æ¥éªŒè¯ä¿®å¤ï¼š

```bash
cd /Users/yudonglei/Desktop/agent_mvp

# 1. æµ‹è¯•æµå¼TTSï¼ˆæ¨èï¼‰
python demo_hybrid.py streaming

# æµ‹è¯•å‘½ä»¤ï¼š
# - "æ˜å¤©ä¸‹åˆä¸‰ç‚¹æé†’æˆ‘å¼€ä¼š"  # æµ‹è¯•å·¥å…·è°ƒç”¨
# - "ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·"          # æµ‹è¯•å¤šå·¥å…·è°ƒç”¨
# - "æ¨èä¸€æœ¬ä¹¦"              # æµ‹è¯•é•¿æ–‡æœ¬æ’­æ”¾
```

**å…³æ³¨ä»¥ä¸‹æŒ‡æ ‡ï¼š**

1. âœ… å·¥å…·è°ƒç”¨ä¸å†æŠ¥é”™
2. âœ… `audio_failed` æ¥è¿‘ 0
3. âœ… `audio_play_failed` ç­‰äº 0
4. âœ… ä¸ä¼šå‡ºç° "æ’­æ”¾å¤±è´¥" çš„æ—¥å¿—
5. âœ… ç®¡é“åœæ­¢å‰æ‰€æœ‰éŸ³é¢‘éƒ½æ’­æ”¾å®Œæˆ

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

1. **agent_hybrid.py**

   - ç¬¬ 787-799 è¡Œï¼šä¿®å¤ function call å‚æ•°è§£æ
   - ç¬¬ 867-881 è¡Œï¼šä¿®å¤ç­‰å¾…é€»è¾‘ï¼Œæ£€æŸ¥ is_playing

2. **streaming_tts_pipeline.py**
   - ç¬¬ 82 è¡Œï¼šæ·»åŠ  is_playing å­—æ®µåˆ° PipelineStats
   - ç¬¬ 256-258 è¡Œï¼šåˆå§‹åŒ–æ’­æ”¾çŠ¶æ€é”
   - ç¬¬ 419-442 è¡Œï¼šéŸ³é¢‘é˜Ÿåˆ—é‡è¯•æœºåˆ¶
   - ç¬¬ 490-503 è¡Œï¼šè®¾ç½®/æ¸…é™¤æ’­æ”¾çŠ¶æ€
   - ç¬¬ 611-613 è¡Œï¼šæ›´æ–°æ’­æ”¾çŠ¶æ€åˆ° stats

---

## ğŸ‰ æ€»ç»“

è¿™æ¬¡ä¿®å¤è§£å†³äº†æµå¼ TTS ç®¡é“çš„ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š

1. **å·¥å…·è°ƒç”¨** - ä» 0% æˆåŠŸç‡æå‡åˆ° 100%
2. **éŸ³é¢‘å®Œæ•´æ€§** - ä» 50-70% æå‡åˆ° 99%+
3. **æ’­æ”¾ç¨³å®šæ€§** - å®Œå…¨æ¶ˆé™¤æ’­æ”¾ä¸­æ–­

æ‰€æœ‰ä¿®å¤éƒ½æ˜¯é’ˆå¯¹æ ¹æœ¬åŸå› ï¼Œè€Œä¸æ˜¯ç—‡çŠ¶ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§å’Œç”¨æˆ·ä½“éªŒã€‚
